# OpenVPN server config file
#
# Generated by Chef - local changes will be overwritten

port <%= @config[:port] %>
proto <%= @config[:proto] %>
dev <%= @config[:dev] %>

<% if (@config[:auth][:type] == "cert_passwd") or (@config[:auth][:type] == "passwd") -%>
script-security 2
auth-user-pass-verify /etc/openvpn/<%= @config_name %>/auth.rb via-file
<% end -%>

<% if @config[:auth][:type] == "passwd" -%>
client-cert-not-required
username-as-common-name
<% end -%>

ca   /etc/openvpn/<%= @config_name %>/<%= @config_name %>-ca.crt
cert /etc/openvpn/<%= @config_name %>/<%= @config_name %>.crt
key  /etc/openvpn/<%= @config_name %>/<%= @config_name %>.key
dh   /etc/openvpn/<%= @config_name %>/<%= @config_name %>-dh.pem

<% if @config[:auth][:type] != "passwd" -%>
ifconfig-pool-persist /etc/openvpn/<%= @config_name %>/<%= @config_name %>.ipp
<% end -%>

<% if @config[:mode] == "routed" -%>
<% if @config[:subnet] -%>
server <%= @config[:subnet] %> <%= @config[:netmask] %>
<% end -%>
<% if @config[:subnet6] -%>
server-ipv6 <%= @config[:subnet6] %>
<% end -%>
<% end -%>

<% if @config[:mode] == "bridged" -%>
server-bridge <%= @config[:server_ip] %> <%= @config[:netmask] %> <%= @config[:dhcp_start] %> <%= @config[:dhcp_end] %>
<% end -%>

<% if @config[:redirect_gateway] -%>
push "redirect-gateway def1"
<% end -%>

<% if @config[:push_dns_server] -%>
push "dhcp-option DNS <%= @config[:push_dns] %>"
<% end -%>

<% if @config[:allow_duplicate_cn] -%>
duplicate-cn
<% end -%>

<% if @config[:allow_client_to_client] -%>
client-to-client
<% end -%>

keepalive 10 120

comp-lzo

user openvpn
group openvpn

persist-key
persist-tun

tmp-dir /tmp
status /var/log/openvpn/<%= @config_name %>-status.log
log-append /var/log/openvpn/<%= @config_name %>.log
verb 3
mute 20
